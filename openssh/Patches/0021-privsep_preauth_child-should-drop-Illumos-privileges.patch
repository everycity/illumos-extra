From 58f44cd270ad7d31bc72ff9c474659cc1dbd4870 Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Tue, 4 Aug 2015 15:50:09 -0700
Subject: [PATCH 21/30] privsep_preauth_child should drop Illumos privileges

---
 sshd.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/sshd.c b/sshd.c
index 1e99488..707dc16 100644
--- a/sshd.c
+++ b/sshd.c
@@ -72,6 +72,7 @@
 #include <string.h>
 #include <unistd.h>
 #include <limits.h>
+#include <priv.h>
 
 #ifdef WITH_OPENSSL
 #include <openssl/dh.h>
@@ -610,6 +611,7 @@ privsep_preauth_child(void)
 {
 	u_int32_t rnd[256];
 	gid_t gidset[1];
+	priv_set_t *pset = NULL;
 
 	/* Enable challenge-response authentication for privilege separation */
 	privsep_challenge_enable();
@@ -649,6 +651,16 @@ privsep_preauth_child(void)
 		fatal("setgroups: %.100s", strerror(errno));
 	permanently_set_uid(privsep_pw);
 #endif
+	/* Drop Illumos privileges */
+	if ((pset = priv_allocset()) == NULL)
+		fatal("priv_allocset failed");
+	priv_emptyset(pset);
+	if (setppriv(PRIV_SET, PRIV_PERMITTED, pset))
+		fatal("setppriv failed: %s", strerror(errno));
+	if (setppriv(PRIV_SET, PRIV_LIMIT, pset))
+		fatal("setppriv failed: %s", strerror(errno));
+	if (setppriv(PRIV_SET, PRIV_INHERITABLE, pset))
+		fatal("setppriv failed: %s", strerror(errno));
 }
 
 static int
-- 
2.3.2 (Apple Git-55)

